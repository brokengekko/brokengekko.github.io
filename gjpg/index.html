<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>2x AIGem JPG</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@^19.1.1",
    "react-dom/": "https://esm.sh/react-dom@^19.1.1/",
    "react/": "https://esm.sh/react@^19.1.1/"
  }
}
</script>
</head>
<body class="bg-gray-900">
    <div id="root"></div>
    <script type="text/babel">
        // --- START OF APP CODE ---

        // IMPORTANT: Your Stability AI API key is placed here for simplicity.
        // This is INSECURE for a public website (like a GitHub repo).
        // Anyone can view the source code and steal your key.
        // Use this for local testing only.
        const STABILITY_API_KEY = 'sk-haoABoMCG6n7omBbo8lzyW8fmQZ01kCvFUvzgQbcjhE6vQI8';

        const { useState, useCallback, useRef } = React;

        // --- Enums and Types ---
        const Stage = {
            PASSCODE: 'PASSCODE',
            UPLOAD: 'UPLOAD',
            DOWNLOAD: 'DOWNLOAD',
        };

        // --- Components ---

        const PasscodeStage = ({ onSuccess, onLockout }) => {
            const CORRECT_CODE = '0911';
            const CODE_LENGTH = 4;
            const [code, setCode] = useState(Array(CODE_LENGTH).fill(''));
            const inputRefs = useRef([]);

            const handleChange = (e, index) => {
                const value = e.target.value;
                if (!/^[0-9]$/.test(value) && value !== '') return;

                const newCode = [...code];
                newCode[index] = value;
                setCode(newCode);

                if (value && index < CODE_LENGTH - 1) {
                    inputRefs.current[index + 1]?.focus();
                }

                if (newCode.join('').length === CODE_LENGTH) {
                    if (newCode.join('') === CORRECT_CODE) {
                        onSuccess();
                    } else {
                        onLockout();
                    }
                }
            };

            const handleKeyDown = (e, index) => {
                if (e.key === 'Backspace' && !code[index] && index > 0) {
                    inputRefs.current[index - 1]?.focus();
                }
            };

            return (
                <div className="flex flex-col items-center justify-center space-y-6 animate-fade-in">
                    <h1 className="text-2xl font-bold text-gray-300">Enter Access Code</h1>
                    <div className="flex space-x-3">
                        {code.map((digit, index) => (
                            <input
                                key={index}
                                ref={(el) => (inputRefs.current[index] = el)}
                                type="password"
                                maxLength={1}
                                value={digit}
                                onChange={(e) => handleChange(e, index)}
                                onKeyDown={(e) => handleKeyDown(e, index)}
                                className="w-16 h-20 bg-gray-800 border-2 border-gray-700 rounded-lg text-center text-4xl font-mono text-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200"
                                autoFocus={index === 0}
                            />
                        ))}
                    </div>
                </div>
            );
        };

        const LoadingSpinner = () => (
            <div className="flex flex-col items-center justify-center space-y-4">
                <svg className="animate-spin h-12 w-12 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                    <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <p className="text-lg text-gray-400">Upscaling image... please wait.</p>
            </div>
        );

        const UploadStage = ({ onComplete }) => {
            const [isDragging, setIsDragging] = useState(false);
            const [isLoading, setIsLoading] = useState(false);
            const [error, setError] = useState(null);

            const processImage = useCallback(async (file) => {
                if (file.type !== 'image/jpeg') {
                    setError('Invalid file type. Please upload a JPG file.');
                    return;
                }

                setError(null);
                setIsLoading(true);

                const formData = new FormData();
                formData.append('image', file);
                formData.append('upscale_level', '2');
                formData.append('output_format', 'jpeg');

                try {
                    const response = await fetch('https://api.stability.ai/v2/image/upscale', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${STABILITY_API_KEY}`,
                            'Accept': 'image/jpeg',
                        },
                        body: formData,
                    });

                    if (!response.ok) {
                        let errorMessage = `API Error: ${response.status} ${response.statusText}`;
                        try {
                            const errorData = await response.json();
                            if (errorData && Array.isArray(errorData.errors)) {
                                errorMessage = `API Error: ${errorData.errors.join(', ')}`;
                            }
                        } catch (e) {
                           // Response not JSON, use status text.
                        }
                        throw new Error(errorMessage);
                    }

                    const imageBlob = await response.blob();
                    
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        const imageDataUrl = reader.result;
                        onComplete(imageDataUrl, file.name);
                    };
                    reader.onerror = () => {
                        throw new Error("Failed to read the upscaled image data.");
                    };
                    reader.readAsDataURL(imageBlob);

                } catch (err) {
                    console.error("Fetch API call failed:", err);
                    let displayError;
                    if (err.message.includes('Failed to fetch')) {
                        displayError = "Image processing failed. This is likely due to browser security (CORS). This app must be run from a web server (http/https) and not a local file. Check the developer console for details.";
                    } else {
                        displayError = err.message;
                    }
                    setError(displayError);
                    setIsLoading(false);
                }
            }, [onComplete]);

            const handleFileChange = (e) => {
                if (e.target.files && e.target.files[0]) {
                    processImage(e.target.files[0]);
                }
            };

            const handleDrop = useCallback((e) => {
                e.preventDefault();
                e.stopPropagation();
                setIsDragging(false);
                if (e.dataTransfer.files && e.dataTransfer.files[0]) {
                    processImage(e.dataTransfer.files[0]);
                }
            }, [processImage]);
            
            const handleDragOver = (e) => {
                e.preventDefault();
                e.stopPropagation();
            };

            const handleDragEnter = (e) => {
                e.preventDefault();
                e.stopPropagation();
                setIsDragging(true);
            };

            const handleDragLeave = (e) => {
                e.preventDefault();
                e.stopPropagation();
                setIsDragging(false);
            };

            if (isLoading) {
                return <LoadingSpinner />;
            }

            return (
                <div className="flex flex-col items-center justify-center space-y-6 w-full animate-fade-in">
                    <h1 className="text-3xl font-bold text-gray-200">Upscale Your JPG</h1>
                    <p className="text-gray-400 text-center">Drag & drop your JPG file or click to select.</p>
                    <div
                        onDrop={handleDrop}
                        onDragOver={handleDragOver}
                        onDragEnter={handleDragEnter}
                        onDragLeave={handleDragLeave}
                        className={`w-full h-64 border-4 border-dashed rounded-xl flex flex-col items-center justify-center transition-colors duration-300 ${isDragging ? 'border-blue-500 bg-gray-800' : 'border-gray-600 bg-gray-800/50'}`}
                    >
                        <input
                            type="file"
                            id="file-upload"
                            className="hidden"
                            accept="image/jpeg"
                            onChange={handleFileChange}
                        />
                        <label htmlFor="file-upload" className="cursor-pointer flex flex-col items-center text-gray-400">
                            <svg className="w-16 h-16 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
                            <span className="text-lg">Drop file here or <span className="text-blue-400 font-semibold">browse</span></span>
                        </label>
                    </div>
                    {error && <p className="text-red-500 mt-4 bg-red-900/50 px-4 py-2 rounded-md">{error}</p>}
                </div>
            );
        };

        const DownloadStage = ({ imageUrl, fileName, onRestart }) => {
            return (
                <div className="flex flex-col items-center justify-center space-y-6 w-full animate-fade-in">
                    <h1 className="text-3xl font-bold text-gray-200">Upscaling Complete!</h1>
                    <div className="w-full bg-gray-800 p-2 rounded-lg shadow-lg flex justify-center">
                        <img 
                            src={imageUrl} 
                            alt="Upscaled result" 
                            className="rounded-md max-w-full h-auto object-contain"
                            style={{ maxHeight: '60vh' }}
                        />
                    </div>
                    <div className="flex space-x-4 w-full">
                        <a
                            href={imageUrl}
                            download={fileName}
                            className="flex-1 bg-blue-600 text-white font-bold py-3 px-6 rounded-lg text-center hover:bg-blue-700 transition-colors duration-300 flex items-center justify-center space-x-2"
                        >
                            <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                            <span>Download</span>
                        </a>
                        <button
                            onClick={onRestart}
                            className="flex-1 bg-gray-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-gray-700 transition-colors duration-300 flex items-center justify-center space-x-2"
                        >
                            <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 4v5h5M20 20v-5h-5M4 4l5 5M20 20l-5-5"></path></svg>
                            <span>Restart</span>
                        </button>
                    </div>
                </div>
            );
        };

        // --- Main App Component ---

        const App = () => {
            const [stage, setStage] = useState(Stage.PASSCODE);
            const [upscaledImage, setUpscaledImage] = useState(null);
            const [isLocked, setIsLocked] = useState(false);
            const [fileName, setFileName] = useState('upscaled.jpg');

            const handlePasscodeSuccess = useCallback(() => {
                setStage(Stage.UPLOAD);
            }, []);

            const handleLockout = useCallback(() => {
                setIsLocked(true);
            }, []);

            const handleUploadComplete = useCallback((imageDataUrl, originalFileName) => {
                setUpscaledImage(imageDataUrl);
                const name = originalFileName.substring(0, originalFileName.lastIndexOf('.'));
                setFileName(`${name}-upscaled-2x.jpg`);
                setStage(Stage.DOWNLOAD);
            }, []);

            const handleRestart = useCallback(() => {
                setUpscaledImage(null);
                setFileName('upscaled.jpg');
                setStage(Stage.UPLOAD);
            }, []);

            const renderStage = () => {
                switch (stage) {
                    case Stage.PASSCODE:
                        return <PasscodeStage onSuccess={handlePasscodeSuccess} onLockout={handleLockout} />;
                    case Stage.UPLOAD:
                        return <UploadStage onComplete={handleUploadComplete} />;
                    case Stage.DOWNLOAD:
                        return upscaledImage ? <DownloadStage imageUrl={upscaledImage} fileName={fileName} onRestart={handleRestart} /> : <UploadStage onComplete={handleUploadComplete} />;
                    default:
                        return <PasscodeStage onSuccess={handlePasscodeSuccess} onLockout={handleLockout} />;
                }
            };

            if (isLocked) {
                return (
                    <div className="bg-black min-h-screen"></div>
                );
            }

            return (
                <main className="bg-gray-900 text-white min-h-screen flex flex-col items-center justify-center p-4 font-sans">
                    <div className="w-full max-w-md mx-auto">
                        {renderStage()}
                    </div>
                </main>
            );
        };

        // --- Mount the App ---
        const rootElement = document.getElementById('root');
        const root = ReactDOM.createRoot(rootElement);
        root.render(<App />);

        // --- END OF APP CODE ---
    </script>
</body>
</html>
